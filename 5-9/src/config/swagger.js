/**
 * Configuraci칩n de Swagger para documentaci칩n autom치tica de la API
 * 
 * Swagger genera documentaci칩n interactiva donde puedes:
 * - Ver todos los endpoints
 * - Probar las peticiones directamente
 * - Ver los modelos de datos
 * - Exportar la especificaci칩n OpenAPI
 */

const swaggerJsDoc = require('swagger-jsdoc');
const swaggerUi = require('swagger-ui-express');

// Configuraci칩n de Swagger
const swaggerOptions = {
  definition: {
    openapi: '3.0.0',
    info: {
      title: 'API RESTful - Sistema de Noticias',
      version: '1.0.0',
      description: `
        API completa para gesti칩n de noticias desarrollada con Node.js, Express y Sequelize.
        
        ## Caracter칤sticas
        - CRUD completo para Usuarios, Perfiles, Estados, Categor칤as y Noticias
        - Autenticaci칩n JWT
        - Validaci칩n de datos
        - Manejo de errores
        - Relaciones entre modelos
        
        ## Autenticaci칩n
        La mayor칤a de los endpoints requieren autenticaci칩n JWT. 
        1. Primero, inicia sesi칩n en \`POST /api/auth/login\`
        2. Copia el token de la respuesta
        3. Haz clic en "Authorize" arriba y pega el token
        4. Ahora puedes probar los endpoints protegidos
      `,
      contact: {
        name: 'API Support',
        email: 'support@noticias.com'
      },
      license: {
        name: 'ISC',
        url: 'https://opensource.org/licenses/ISC'
      }
    },
    servers: [
      {
        url: 'http://localhost:3000',
        description: 'Servidor de desarrollo'
      },
      {
        url: 'https://api.noticias.com',
        description: 'Servidor de producci칩n'
      }
    ],
    // Configuraci칩n de seguridad JWT
    components: {
      securitySchemes: {
        bearerAuth: {
          type: 'http',
          scheme: 'bearer',
          bearerFormat: 'JWT',
          description: 'Ingresa el token JWT obtenido del login'
        }
      },
      // Definici칩n de esquemas de datos
      schemas: {
        // ===== ESTADO =====
        Estado: {
          type: 'object',
          required: ['nombre'],
          properties: {
            id: {
              type: 'integer',
              description: 'ID 칰nico del estado'
            },
            nombre: {
              type: 'string',
              description: 'Nombre del estado',
              example: 'Activo'
            },
            descripcion: {
              type: 'string',
              description: 'Descripci칩n del estado',
              example: 'Estado activo para contenido publicado'
            },
            color: {
              type: 'string',
              description: 'Color hexadecimal para UI',
              example: '#28a745'
            },
            createdAt: {
              type: 'string',
              format: 'date-time',
              description: 'Fecha de creaci칩n'
            },
            updatedAt: {
              type: 'string',
              format: 'date-time',
              description: 'Fecha de 칰ltima actualizaci칩n'
            }
          }
        },
        
        // ===== PERFIL =====
        Perfil: {
          type: 'object',
          required: ['nombre', 'nivel_permiso'],
          properties: {
            id: {
              type: 'integer',
              description: 'ID 칰nico del perfil'
            },
            nombre: {
              type: 'string',
              description: 'Nombre del perfil/rol',
              example: 'Administrador'
            },
            descripcion: {
              type: 'string',
              description: 'Descripci칩n del perfil',
              example: 'Usuario con acceso completo al sistema'
            },
            nivel_permiso: {
              type: 'integer',
              description: 'Nivel de permisos (1-3)',
              example: 3,
              minimum: 1,
              maximum: 3
            },
            createdAt: {
              type: 'string',
              format: 'date-time'
            },
            updatedAt: {
              type: 'string',
              format: 'date-time'
            }
          }
        },
        
        // ===== USUARIO =====
        Usuario: {
          type: 'object',
          required: ['nombre', 'email', 'password', 'id_perfil', 'id_estado'],
          properties: {
            id: {
              type: 'integer',
              description: 'ID 칰nico del usuario'
            },
            nombre: {
              type: 'string',
              description: 'Nombre completo del usuario',
              example: 'Juan P칠rez'
            },
            email: {
              type: 'string',
              format: 'email',
              description: 'Email 칰nico del usuario',
              example: 'juan@example.com'
            },
            password: {
              type: 'string',
              format: 'password',
              description: 'Contrase침a encriptada',
              example: 'password123'
            },
            telefono: {
              type: 'string',
              description: 'Tel칠fono del usuario',
              example: '+1234567890'
            },
            avatar: {
              type: 'string',
              description: 'URL de la imagen de perfil',
              example: 'https://example.com/avatar.jpg'
            },
            id_perfil: {
              type: 'integer',
              description: 'ID del perfil/rol asignado',
              example: 1
            },
            id_estado: {
              type: 'integer',
              description: 'ID del estado del usuario',
              example: 1
            },
            createdAt: {
              type: 'string',
              format: 'date-time'
            },
            updatedAt: {
              type: 'string',
              format: 'date-time'
            },
            perfil: {
              $ref: '#/components/schemas/Perfil'
            },
            estado: {
              $ref: '#/components/schemas/Estado'
            }
          }
        },
        
        // ===== CATEGOR칈A =====
        Categoria: {
          type: 'object',
          required: ['nombre'],
          properties: {
            id: {
              type: 'integer',
              description: 'ID 칰nico de la categor칤a'
            },
            nombre: {
              type: 'string',
              description: 'Nombre de la categor칤a',
              example: 'Tecnolog칤a'
            },
            descripcion: {
              type: 'string',
              description: 'Descripci칩n de la categor칤a',
              example: 'Noticias sobre tecnolog칤a e innovaci칩n'
            },
            slug: {
              type: 'string',
              description: 'Slug URL-friendly',
              example: 'tecnologia'
            },
            icono: {
              type: 'string',
              description: 'Icono o emoji',
              example: '游눹'
            },
            color: {
              type: 'string',
              description: 'Color hexadecimal',
              example: '#007bff'
            },
            createdAt: {
              type: 'string',
              format: 'date-time'
            },
            updatedAt: {
              type: 'string',
              format: 'date-time'
            }
          }
        },
        
        // ===== NOTICIA =====
        Noticia: {
          type: 'object',
          required: ['titulo', 'contenido', 'id_categoria', 'id_estado'],
          properties: {
            id: {
              type: 'integer',
              description: 'ID 칰nico de la noticia'
            },
            titulo: {
              type: 'string',
              description: 'T칤tulo de la noticia',
              example: 'Nueva tecnolog칤a revoluciona el mundo'
            },
            slug: {
              type: 'string',
              description: 'Slug generado autom치ticamente',
              example: 'nueva-tecnologia-revoluciona-mundo'
            },
            resumen: {
              type: 'string',
              description: 'Resumen breve',
              example: 'Un breve resumen de la noticia...'
            },
            contenido: {
              type: 'string',
              description: 'Contenido completo de la noticia',
              example: 'El contenido completo de la noticia con todos los detalles...'
            },
            imagen: {
              type: 'string',
              description: 'URL de la imagen principal',
              example: 'https://example.com/imagen.jpg'
            },
            vistas: {
              type: 'integer',
              description: 'N칰mero de vistas',
              example: 0
            },
            fecha_publicacion: {
              type: 'string',
              format: 'date-time',
              description: 'Fecha de publicaci칩n'
            },
            id_usuario: {
              type: 'integer',
              description: 'ID del autor'
            },
            id_categoria: {
              type: 'integer',
              description: 'ID de la categor칤a',
              example: 1
            },
            id_estado: {
              type: 'integer',
              description: 'ID del estado',
              example: 1
            },
            createdAt: {
              type: 'string',
              format: 'date-time'
            },
            updatedAt: {
              type: 'string',
              format: 'date-time'
            },
            autor: {
              $ref: '#/components/schemas/Usuario'
            },
            categoria: {
              $ref: '#/components/schemas/Categoria'
            },
            estado: {
              $ref: '#/components/schemas/Estado'
            }
          }
        },
        
        // ===== RESPUESTAS =====
        Error: {
          type: 'object',
          properties: {
            success: {
              type: 'boolean',
              example: false
            },
            message: {
              type: 'string',
              example: 'Error al procesar la solicitud'
            },
            errores: {
              type: 'array',
              items: {
                type: 'object',
                properties: {
                  campo: {
                    type: 'string'
                  },
                  mensaje: {
                    type: 'string'
                  }
                }
              }
            }
          }
        },
        
        Success: {
          type: 'object',
          properties: {
            success: {
              type: 'boolean',
              example: true
            },
            message: {
              type: 'string',
              example: 'Operaci칩n exitosa'
            },
            data: {
              type: 'object'
            }
          }
        },
        
        LoginRequest: {
          type: 'object',
          required: ['email', 'password'],
          properties: {
            email: {
              type: 'string',
              format: 'email',
              example: 'admin@noticias.com'
            },
            password: {
              type: 'string',
              format: 'password',
              example: 'admin123'
            }
          }
        },
        
        LoginResponse: {
          type: 'object',
          properties: {
            success: {
              type: 'boolean',
              example: true
            },
            message: {
              type: 'string',
              example: 'Login exitoso'
            },
            token: {
              type: 'string',
              example: 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9...'
            },
            usuario: {
              $ref: '#/components/schemas/Usuario'
            }
          }
        }
      }
    },
    // Aplicar seguridad JWT a todos los endpoints por defecto
    security: [
      {
        bearerAuth: []
      }
    ]
  },
  // Archivos donde buscar anotaciones de Swagger
  apis: ['./src/routes/*.js', './src/controllers/*.js', './src/models/*.js']
};

// Generar especificaci칩n Swagger
const swaggerSpec = swaggerJsDoc(swaggerOptions);

// Opciones de personalizaci칩n de la UI
const swaggerUiOptions = {
  customCss: '.swagger-ui .topbar { display: none }',
  customSiteTitle: 'API Noticias - Documentaci칩n',
  swaggerOptions: {
    persistAuthorization: true,
    displayRequestDuration: true,
    filter: true,
    tryItOutEnabled: true
  }
};

module.exports = {
  swaggerUi,
  swaggerSpec,
  swaggerUiOptions
};